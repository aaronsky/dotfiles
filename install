#!/bin/sh

set -eu

is_macos() {
    [ "$(uname -s)" = "Darwin" ]
}

is_linux_or_redhat() {
    [ "$(uname -s)" = "Linux" ] || [ "$(uname -s)" = "RedHat" ]
}

has() {
    command -v "$1" >/dev/null
}

link() {
    src="$1"
    dest="$2"

    [ -e "$src" ] || return 1

    mkdir -p "$(dirname "$dest")"

    ln -sfv "$src" "$dest"
}

reload_session() {
    :
}

install_dotfiles() {
    link "git/.gitconfig" "$HOME/.gitconfig"
    link "git/.gitignore_global" "$HOME/.gitignore_global"
    link "mise" "$HOME/.config/mise/"
    link "nvim" "$HOME/.config/nvim/"
    link "shells/.profile" "$HOME/.profile"
    link "shells/.zprofile" "$HOME/.zprofile"
    link "shells/.zshenv" "$HOME/.zshenv"
    link "shells/.zshrc" "$HOME/.zshrc"
    link "shells/fish" "$HOME/.config/fish"
    link "shells/nushell" "$HOME/.config/nushell"
    link "shells/nushell" "$HOME/Library/Application Support/nushell"
    link "shells/starship.toml" "$HOME/.config/starship.toml"
    link "ssh/config" "$HOME/.ssh/config"
}

install_xcode_command_line_tools() {
    [ -e "/Library/Developer/CommandLineTools/usr/bin/git" ] && return 0

    xcode-select --install

    if ! xcode-select --print-path >/dev/null 2>&1; then
        sudo xcode-select --switch /Library/Developer/CommandLineTools
    fi

    [ -e "/Library/Developer/CommandLineTools/usr/bin/git" ] || return 1
}

install_homebrew_if_needed() {
    has brew && return 0

    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    has brew || return 1
}

prepare_system() {
    has git || return 1

    git config --global credential.helper osxkeychain
}

install_homebrew_formula() {
    has brew || return 1

    brew install "$@"
    brew cleanup
}

setup_mise_environment() {
    has mise || return

    mise install
}

install_dotfiles && reload_session
install_xcode_command_line_tools
install_homebrew_if_needed
prepare_system
install_homebrew_formula \
    bash \
    bazelisk \
    fish \
    git \
    gh \
    mise \
    nushell \
    ripgrep \
    shellcheck \
    shfmt \
    starship \
    zoxide
setup_mise_environment
